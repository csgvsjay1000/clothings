
# JVM知识梳理 #

- JVM运行时数据区域
	* 程序计数器
	* java虚拟机栈
	* 本地方法栈
	* 堆
	* 方法区
	* 运行时常量池
	* 直接内存

- JVM调优总结
	* 堆/栈大小设置
	* 辅助信息
	
- 线上问题排查
	* CPU爆表	
	* 请求无法响应，tomcat假死，应用服务器CPU使用率不高
	
## JVM运行时数据区域  ##

	Java虚拟机在执行java程序时，会把它管理的内存划分为若干个不同的数据区域。
	java 1.8之前的版本：
		* 运行时区域：
		* 直接内存：
	java 1.8：方法区和运行时常量池放到直接内存区域。
- 运行时区域：又分为线程共享区域和线程私有
	* 线程共享区域：堆、方法区、运行时常量池。
	* 线程私有区：虚拟机栈、本地方法栈、程序计数器。

## JVM调优总结  ##

### 堆/栈大小设置  ###
	常用设置：java -Xmx3550m -Xms3550m -Xmn2g –Xss128k， 此设置代表设置最大和最小堆内存为3550m, 新生代2g，栈大小为128k，线程不宜过多，1000以内。
### 辅助信息  ###	

	JVM提供了大量的命令行参数，打印信息。
	
- -XX:+PrintGC 
- -XX:+PrintGCDetails

	
## 线上问题排查  ##

###  CPU爆表	###
	
	一个应用CPU占用很高，除了是计算密集型应用，大部分原因都是死循环引起的，重复生成对象造成频繁GC。
		
- 第一步：根据top命令发现某PID为 22323 的java进程CPU使用率200%
- 第二部：通过ps aux | grep PID 发现为某应用java程序
- 第三步：定位问题线程，通过top -H -p pid  显示线程列表，找到占用CPU时间钟最高的线程，其中tid为线程ID，为10进制，需要将其转为16进制，供后面命令使用
- 第四步：打印该线程堆栈信息，jstack pid | grep tid -A30, 仔细查看线程堆栈信息，即可找出问题

### 请求无法响应，tomcat假死，应用服务器CPU使用率不高  ###
	
	很有可能是线程被阻塞了
	
- 通过jstack查看http线程，被阻塞在哪里，可能是访问数据库被阻塞，或者访问redis被阻塞等等。
	
	
15042 root      20   0 4865120 2.051g  14908 R 97.3 26.9  15:16.20 java                                                                                                                                                                         
15041 root      20   0 4865120 2.051g  14908 R 96.3 26.9  15:15.64 java                                                                                                                                                                         
15043 root      20   0 4865120 2.051g  14908 S  2.3 26.9   0:29.97 java                                                                                                                                                                         
15039 root      20   0 4865120 2.051g  14908 S  0.0 26.9   0:00.00 java                                                                                                                                                                         
15040 root      20   0 4865120 2.051g  14908 S  0.0 26.9   0:39.47 java                                                                                                                                                                         
15044 root      20   0 4865120 2.051g  14908 S  0.0 26.9   0:00.03 java                                                                                                                                                                         
15045 root      20   0 4865120 2.051g  14908 S  0.0 26.9   0:00.06 java                                                                                                                                                                         
15046 root      20   0 4865120 2.051g  14908 S  0.0 26.9   0:00.00 java  	
	