
# 03-文件

- 3.1 参数文件
- 3.2 日志文件
- 3.6 InnoDB存储引擎文件

## 3.1 参数文件

- 动态参数：全局和会话期间。
- 静态参数

## 3.2 日志文件

### 3.2.1 错误日志

通过 **show variables like 'log_error'** 可以定位到错误路径，然后进行查看。

### 3.2.2 慢查询日志

慢查询日志可以帮助DBA定位到可能存在问题的SQL语句。DBA应该每天或每隔几天对其进行检查，当查询语句超过设定时间就会记录到慢查询日志文件里。

若查询语句没有用到索引，且也打开了监控没有用到索引的查询，也会将该类语句记录到慢查询日志文件中。

### 3.2.3 查询日志

查询日志记录了所有对MYSQL的请求信息

### 3.2.4 二进制日志

二进制日志记录了对MySQL执行更改的所有操作，二进制日志主要有以下作用：

- 恢复：
- 复制
- 审计：通过二进制日志中的信息进行审计，来判断是否有对数据库进行注入攻击。

通过配置参数 bin-log [=name] 可以启动二进制，如果不指定name，则默认用主机名，后缀为二进制日志的序列号。所在路径为数据库所在目录(datadir)

以下配置参数影响二进制日志记录的信息和行为：

- max\_binlog\_size: 
- binlog\_cache\_size:
- sync_binlog
- binlog\-do\-db
- binlog\_ignore\_db
- log\_slave\_update
- binlog_format


**1. max\_binlog\_size**
指定了单个二进制文件的最大值，若超过该值则生成新的二进制文件，后缀名+1，默认值为1G。

**2. binlog\_cache\_size**
当使用事物表存储引擎，所有未提交的二进制日志会被记录到一个缓存离去，当事物提交后，直接将缓冲里的日志写入二进制文件，该缓冲大小由**binlog\_cache\_size** 指定，默认大小为32K。该大小是基于会话的，设置太大和太小都不合适，可以通过查看binlog\_cache\_use和binlog\_cache\_disk\_use来判断设置是否合适，因为当一个事物的记录大于这个size，mysql将会将缓冲日志写到临时文件中去。


**3. sync\_binlog** 默认情况下，二进制日志并不是每次写的时候都同步到磁盘。因此，当发生宕机时，会有一部分数据丢失。参数sync_binlog=[N]表示没写多少次缓冲，就同步到磁盘，如果设为1，则表示使用同步磁盘的方式来写二进制日志，这时候就不用缓冲日志写了，默认为0。

**4. binlog\-do\-db和binlog\_ignore\_db** 表示需要写入或忽略哪些db的日志，默认为null。

**5. log\_slave\_update** 如果当前数据库角色是slave，则它不会将从master复制的binlog，且执行的日志记录到自己的binlog中去，如果需要写入，需要设置该参数。如果要搭建 master => slave => slave架构，才需要该设置。

**6. binlog_format** 该参数非常重要，影响了记录二进制日志的格式。该参数可设置的值有:statement、row、mixed。

- statement：记录的是逻辑的SQL语句。
- row：记录的是表行的更改情况。
- mixed：是混合情况，默认情况下是statement，但有些语句是row格式。

通常情况下，我们会将格式设为row，这为数据的恢复和复制带来更好的可靠性。但是二进制文件大小会增加。

## 3.6 InnoDB存储引擎文件

之前介绍的都是MySQL数据库本身的文件，除此之外每个存储引擎都会有自身的文件，下面将介绍InnoDB存储引擎相关文件，包括重做日志文件，表空间文件。

### 3.6.1 表空间文件

InnoDB将数据存放在表空间里，默认配置会有一个初始大小为10M,名为ibdata1的文件，该文件时默认表空间文件。同时用户可以设置innodb\_data\_file\_path进行设置，可以设置多个表空间文件。可以将多个文件映射到不同的磁盘上，可以提高数据库性能。

设置innodb\_data\_file\_path后，所有存储的数据都会存储到该共享空间表里去。

若设置innodb\_file\_per\_table参数后，存储引擎将为每个表产生一个独立表空间文件。名字为表名.ibd。

### 3.6.2 重做日志文件

在默认情况下，InnoDB引擎的数据目录下会有两个名为ib_logfile0和ib_logfile1的文件，这两个文件就是重做日志文件。每个InnoDB引擎至少有一个重做日志文件组，每个组下至少两个重做日志文件。为了得到更高的可靠性，可以设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。

innodb\_log\_file\_size 重做日志文件大小设置对存储引擎性能影响很大，一方面该值不能设置太大，太大恢复需要很长时间，另一方面不能设置太小，否则一个事物日志需要多次切换重做日志，此外太小还会导致频繁发生async checkpoint。因为重做日志有个capacity容量变量，该值代表了最后检查点不能超过该值，若超过了则必须将缓冲池内脏页列表的部分脏页数据写会磁盘。

与二进制日志不同的是，二进制是记录整个mysql数据变更的逻辑日志，重做日志是记录每个页更改的物理情况。

