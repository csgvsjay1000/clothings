
# 02-Innodb存储引擎

- 2.1 体系结构


## 2.1 体系结构

- 2.1.1 后台线程
- 2.1.2 内存
- 2.1.3 CheckPoint

### 2.1.1 后台线程

InnoDB存储引擎是多线程模型，其后台有多个不同的后台线程。分别为：Master Thread、IO Thread、Purge Thread。

- Master Thread：是一个非常核心的线程，主要将缓冲池的数据刷入到异步磁盘，保证数据的一致性。包括脏页的刷新、合并插入缓冲（Insert Buffer）、Undo页的回收。
- IO Thread：在Innodb中大量使用了AIO来处理IO请求。
- Purge Thread：清理线程

### 2.1.2 内存

**缓冲池**

- InnoDB是基于磁盘存储的，由于磁盘与CPU速度存在鸿沟，基于磁盘的存储系统通常都用缓冲池技术来提供数据库系统性能。
- 缓冲池简单来说是一块内存区域，数据库进行页的读取时，先将磁盘读到的页放到缓冲池中。下次读相同的数据时，直接从缓冲池读取。
- 对于数据库的修改操作，也是先修改缓冲池中页的数据，再按一定的频率刷新磁盘，这里缓冲池刷回到磁盘并不是页变更的时候，而是通过一种CheckPoint的机制回磁盘的。
- 因此缓冲池的大小直接影响数据库性能。对于InnoDB引擎而言，其缓冲池的配置通过innodb_buffer_pool_size参数控制。

**缓冲池缓存数据种类**

缓冲池缓存的数据有：数据页、索引页、undo页、插入缓冲、自适应hash索引、锁信息、数据字典信息。其中索引页和数据页占很大一部分。

**缓冲池管理算法**

缓冲池是一块内存区域，当内存不够缓存新的页时，缓冲池一般采用LRU方法管理内存，即最近最少使用的页将移除缓存。
缓冲池页的大小默认为16K


**重做日志缓冲**

InnoDB的内存除了有缓冲池外，还有重做日志缓冲区，通过innodb_log_buffer_size控制，一般该区域内存不大。
InnoDB首先将重做日志信息放入该缓冲区，再每一秒刷新到重做日志文件。
通常情况下8M重做日志缓冲内存足够满足大部分应用，因为重做日志在以下三种情况会将日志刷新到日志文件中：

- Master Thread 每隔一秒将重做日志缓冲刷入到重做日志文件中。
- 每个事物事物提交时会将重做日志缓冲刷入到日志文件。
- 当该空间剩余空间不足一半时，将刷新到日志文件中。

### 2.1.3 CheckPoint
 
前面已经讲到页的操作首先都是在缓冲池中完成的，如果一条DML语句，如Delete或update的语句改变了页中的记录，那么此时该页称为脏页。即缓冲池中的数据比磁盘中的新，数据库需要将该数据刷到磁盘。

若每一次页的改变都需要刷回磁盘，那么性能将比较差。
同时若缓冲池中的页还没刷新到磁盘中时，数据库宕机，就会造成数据丢失问题。
为了避免数据库丢失问题，当前系统都是采用Write AHead Log，先写重做日志。

使用CheckPoint可以解决一下问题：

- 缩短数据库恢复时间；
- 缓冲池不够用时，将脏页刷新到磁盘；
- 重做日志不可用时，刷新脏页；

此外，当缓冲池不够用时，根据LRU算法，将移除最近最少使用的页，若该页为脏页，则强制执行CheckPoint，将新数据刷到磁盘。
重做日志出现不可用的情况是








