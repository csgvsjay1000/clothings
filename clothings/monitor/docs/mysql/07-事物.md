
# 07-事物

## 7.1 认识事物

### 7.1.1 概述

在事物中一般有以下4个概念：

- 原子性
- 一致性
- 隔离性
- 持久性

我们先具体介绍事物的这四个概念。

**原子性**：即事物中任何一个SQL执行失败，已经执行成功的SQL必须撤销，数据库回到事物执行前的状态。

**一致性**：比如一个唯一索引的字段，事物更新之前是唯一的，新增或修改记录，该字段仍然是唯一的。

**隔离性**：隔离性还有其他称呼，如并发控制，锁等。事物隔离性要求每个读写事物的对象，对其他事物操作的对象相互隔离，即该事物提交前对其他事物都不可见。通常使用锁来实现，当前数据库都提供了粒度锁，允许事物仅锁住一个实体对象的子集，即行锁，以此来提供系统的并发。

**持久性**：事物一旦提交，其结果是永久性的。即使数据库宕机，也能通过某些方法将数据恢复，前提是磁盘没有损坏。

### 7.1.2 分类 

从事物理论的角度可以把事物分为以下几种类型：

- 扁平事物
- 带有保存点的扁平事物

## 7.2 事物的实现

### 7.2.1 redo

**1. 基本概念**

重做日志用来实现事物的持久性，其由两部分组成：一是内存中的重做日志缓冲，其是易失的；二是重做日志文件，其是持久的。

InnoDB是事物的存储引擎，其通过Force log at commit机制实现事物的持久性，即当事物提交时，必须先将事物所有日志写入到重做日志文件。redo log基本上是顺序写的，在数据库运行时不需要读取redo log文件。

为了确保日志都写入重做日志文件，引擎将缓冲日志写入文件后都需要调用一次fsync操作，由于重做日志文件打开没有使用O_DRIECT选项，因此日志缓冲先写入文件系统缓存，为确保写入磁盘，必须进行一次fsync，而fsync的性能取决于磁盘，因此磁盘的性能决定了事物的性能。

InnoDB允许用户手工设置非持久性情况的发生，通过设置 **innodb_flush_log_at_trx_commit** 用来控制日志刷盘策略，该参数默认值为1、即每次提交事物必须刷盘。可以设置该参数值为0和2,0表示事物提交时不写入重做日志操作，刷盘操作仅在Master Thread线程完成，在Master Thread每1秒会进行重做日志刷盘操作。2表示提交是只写入文件缓存系统，不进行刷盘操作。在2这个设置下，数据库宕机但系统没有宕机，数据不会丢失。

**binlog与redo log 异同**：binlog主要用来进行恢复和主从复制的建立。其次重做日志是InnoDB层产生的，而binlog是MySQL层生成的。binlog记录的是SQL语句，redo log记录的是对页的修改。写入的时间点也不同，binlog在事物提交完成后一次写入，redo log则是事物进行中不断写入。

### 7.2.2 undo

**1. 基本概念**

重做日志记录了事物的行为，可以很好的通过其对页进行重做操作。但事物有时需要回滚，这是需要undo。因此InnoDB在堆数据库修改时，不仅产生redo，也产生undo。

redo存放在重做日志文件中，undo是存放在数据库一个段中，可以通过脚本查看共享空间中undo段中页的数量。

通常用户会对undo有这样的误解：undo将数据库物理恢复到事物之前的样子，实际并非如此。undo是逻辑日志，所有的修改被逻辑的取消了。

例如，用户执行了一个insert 10W记录的事物，在回滚时，会做与之前相反的事，对于每个Insert会执行一个delete,每个delete会执行一个insert。对于update，会执行一个与之前相反的update。

除了回滚操作，undo还可以用来MVCC,多版本控制，实现非锁定读取。当用户读取一行记录时，若该记录已经被其他事物占用，当前事物通过undo读取之前版本信息。

**2. undo存储管理**

InnoDB存储引擎有rollback segment, 每个回滚段有1024个undo log segment, 而在每个undo log segment中进行undo 页的申请。当事物提交时，InnoDB会做以下两件事：

- 将undo log放入列表，以供之后的purge操作；
- 判断undo log所在的页是否可以重用，若可以分配各下个事物使用。

事物提交后并不能马上删除undo log及undo log所在的页，因为还有其他的事物可能正在使用，是否可以删除由purge线程来判断。

## 7.8 不好的事物习惯

### 7.8.1 在循环中提交
### 7.8.2 使用自动提交







