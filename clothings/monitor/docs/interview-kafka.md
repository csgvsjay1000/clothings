
## kafka知识梳理

- 消息丢失怎么办
- 如何保证消息顺序性
- 如何保证消息不被重复消费
- 如何解决消息队列延时以及过期失效问题
- 消息队列满了之后怎么处理, 有几百万消息持续积压几小时呢
- 如果让你设计消息队列，如何进行架构设计

### 1、什么是消息队列 ###

	消息队列是一个存放消息的容器，当我们需要消费消息的时候，可以取出消息供自己使用。

### 2、为什么要使用消息队列 ###

- 系统销峰，处理短时间产生的瞬间高峰请求
- 降低系统的耦合性。（比如：服饰工厂发货端，生成发货数据后，生成一条发货消息给仓库收货端，仓库收到这个请求后，根据发货端数据生成收货数据）


### 3、使用消息队列之后会带来什么问题 ###

- 怎么保证消息消费顺序 。(尽量使用不要求消费顺序的消息) 
- 保证消息不被重复消费 。（尽量利用消费端保证消息的不重复消费，比如利用数据库惟一建保证，或redis保证）  
- 保证消息不丢失。（尽量利用消息发送端超时检测机制保证，消息丢失的概率很小）


### 4、市场上消息队列比较 ###

- ActiveMQ 性能较差，支持万级吞吐量,不推荐使用
- RabitMQ 并发能力强(指可以支持大量客户端连接)，支持万级吞吐量，延时很低微妙级us,其他都是毫秒级ms
- RocketMQ 支持百万级吞吐量,理论上不丢失消息, 阿里出品
- KafkaMQ 支持百万级吞吐量，理论上不丢失消息, 大数据领域的标准

### 消息丢失怎么办  ###

	消息丢失可能产生在：生产端、消息中间件、消费端
- 消息在生产端传入到中间件过程中丢失
- 中间件收到消息，暂存内存，中间件挂掉，消息丢失
- 消费者收到消息，还未消费完，消费者挂掉，中间件以为消费者已经消费。

#### 生产者消息丢失怎么办  ####

- 为每条消息维护一个业务ID，利用回调机制，若消息发送失败，可以考虑重新发送,或定时重新发送

#### 中间件丢失消息丢失怎么办  ####
	kafka生产端弄丢数据，属于较为常见。就是比如某个leader broker宕机，然后其follower切换为leader，但这个follower在升为leader前，刚好还有些数据没有同步，就会丢失一些数据。所以此时可以为broker至少配置如下4个参数,就会保证数据不会丢失。
- topic的replication.factor，这个值至少大于1，每个partition至少两个副本，一个leader，一个follower
- 在kafka服务端设置min.insync.replicas，这个参数必须大于1，这是ISR集合中副本数
- producer端设置ack=all，这个要求写入所有ISR成功之后才返回给客户端
- producer设置retries=Integer.Max，由于网络抖动的原因，会一直重试

#### 消费端丢失消息丢失怎么办  ####

- 关闭自动提交消费位移，等消费成功后手动提交。可能会导致重复消费，这是另外一个问题。
