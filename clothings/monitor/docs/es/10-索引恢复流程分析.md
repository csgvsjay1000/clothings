
# 10-索引恢复流程分析

- 相关配置
- 流程概述
- 主分片恢复流程
- 副分片恢复流程
- recovery速度优化
- 如何保证主副分片一致
- recovery相关监控

索引恢复是ES数据恢复过程，待恢复的数据是客户端写入成功，但未执行刷盘(flush)的Lucene分段。例如，在节点异常重启时，或写入操作在多个分片未来的及全部执行时，副分片需要和主分片
完全一致。根据数据分片性质，索引恢复过程可分为：主分片恢复和副分片恢复

- 主分片从translog中自我恢复
- 副分片恢复，需要从主分片拉取lucene分段，和translog恢复，但是有机会跳过拉取lucene分段过程

## 相关配置

索引恢复流程有以下配置项

- indices.recovery.max_bytes_per_sec: 副分片恢复的phase1阶段，主副分片节点之间传输数据速度，默认为40MB/s, 若0为不限制
- indices.recovery.retry_delay_state_sync: 由于集群状态同步导致recovery失败时，重试recovery前等待时间，默认500ms
- indices.recovery.retry_delay_network: 由于网络问题导致recovery失败时，重试前等待时间，默认5s

## 主分片恢复流程

主要工作是重放translog日志，总共分为几个阶段：

- Init阶段：初始化阶段的主要工作是一些验证工作，如校验当前分片是否为主分片信息，分片状态是否异常等
- Index阶段：从Lucene读取最后一次提交的分段信息，获取其中的版本号，更新当前索引版本
- verify_index: 这里Index是指lucene中的Index，验证当前分片是否损坏，当索引数据量较大时，分片检查将会消耗大量的时间，默认不执行此阶段
- tanslog阶段：
	* 一个Lucene索引由许多分段组成，每次搜索时，遍历所有分段。内部维护了一个称为“提交点”的信息，其描述了当前lucene索引都包括哪些分段，这些分段已经被fsync系统调用。
	* 本阶段需要重放事物日志中尚未刷入磁盘的信息，因此根据最后一次提交的信息做快照，来确定事物日志中，哪些数据需要被重放，重放完毕后，将新生成的数据刷入磁盘。
- finalize阶段：本阶段执行刷新(refresh)操作，将缓冲的数据写入文件，但不刷盘
- Done阶段：是恢复阶段的最后一个工作，进入done之前再次执行refresh，然后更新分片状态	
	





 
	
	
