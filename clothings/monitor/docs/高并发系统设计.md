
# 如何设计一个高并发系统 #

- 何为高并发?
- 高并发系统架构是怎样的（一）？
- 高并发系统架构是怎样的（二）？
- 怎么部署的？
- 部署了多少台机器?
- 缓存怎么用？
- MQ怎么用？
- 数据库怎么用？


## 何为高并发 ##

- 刚开始系统都是直接连数据库的，但数据库每秒支撑到两三千基本就挂了。（由此衍生出数据库监控系统）
- 现在互联网人越来越多，很多APP都是高并发请求，高并发期，每秒几千并发很正常，再有双十一或促销活动，每秒并发几万十几万都有可能。

## 高并发系统架构是怎样的（一） ##

- 请求处理：如果客户请求，2~4s内没有返回，80%的用户会再次点击，这样会给服务器更大的压力，所以前台控制，固定时间内不能重复点击，或mark处理
- 网络改善: 由于网络原因导致响应时间变长，改善网络环境，南电信，北网通。
- CDN：CDN将数据，静态资源放到运营商机房，用户访问从最近的路径开始获取数据
- 反向代理：当请求到达时，先访问反向代理服务器，反向代理服务器把缓存数据返回给客户，如果没有缓存，才将请求专制应用服务器。
- 负载均衡：应用服务器前部署负载均衡器，根据分发策略，将请求发到多个节点

## 高并发系统架构是怎样的（二） ##
	
- 系统拆分
- 缓存
- MQ
- 分库分表
- 读写分离
- ElasticSearch

### 第一步 系统拆分 ###

- 将系统拆分为多个子系统，用dubbo该服务通信，每个系统连接一个数据库，这样本来一个库，现在多个库可以抗住高并发

### 第二步 缓存 ###

- 使用缓存，大部分高并发场景都是读多写少，用redis可以轻松抗住单机几万的并发

### 第三步 MQ ###

- 使用MQ，再使用缓存读之后，可能还是会有高并发写的情况，比如一个业务里频繁操作数据库
- 使用MQ将大量写请求灌入MQ，后台配备多个消费端，慢慢消费。MQ单机抗几万并发也是很OK的

### 第四步 分库分表 ###

- 可能数据库还是会有高并发请求，那么将数据库分库分表，每个表的数据量少一点，可以提高SQL跑的性能。

### 第五步 ElasticSearch ###

- ES是一个分布式搜索引擎，可以随意扩容，天然支持高并发，一些比较简单的查询，统计可以使用ES来承载。

## 怎么部署的 ##
	服饰系统一共七个服务,一共多少台机器
	
- 基础服务：（用户注册，登录，权限管理）  2个实例
- 基础档案：门店档案，商品档案 2个实例
- 标签服务：商品标签库存管理、绑定、解绑、标签生命周期  （3个实例）
- 工厂服务：工厂发货、工厂收货 （2个实例）
- 仓库服务：仓库收货、仓库横调、仓库退货到工厂、仓库配货到门店  （2个实例）
- 门店服务：门店收货、门店横调、门店退货 （2个实例）
- 盘点服务：包括仓库盘点、门店盘点 （2个实例）

20台机器

- 5台部署第三方中间件  

## 缓存怎么用 ##

- 经常查看标签的商品信息，装箱发货时都需要查看标签的状态，标签是否可以装箱。（永不过期，若发现商品不对，可以手动操作，或再次绑定解绑）
- 根据条码缓存商品信息，比较少变。（永不过期）

## MQ怎么用 ##

- 工厂装完箱，点击发货时，会本地存储EPC,同时发到收货端，也生成收货EPC数据，还会给外部系统发送发货单，过程响应会比较长，所以用MQ。
- 仓库收完货时，点击发给发货单，让其修改发货信息，也会响应比较长使用MQ提高吞吐量。

## 分库分表怎么用 ##

- 整个EPC基于hash值分库分表, 因为EPC数据比较大，亿级别数据, 以及EPC操作流水表。会定期清除2年以上的数据
- 装箱发货、收货流程均使用分库分表。每隔半年1张表, 单箱的流水信息
- 盘点单、任务明细，也使用分库分表，每隔半年1张表
- 盘点结果，每款帐存和实际差异数

## ElasticSearch怎么用 ##

- 整个EPC最新状态数据存入ES中，以做统计聚合分析，比如某个门店，某个款的数量，或者某个此存的库存数
- 根据单号箱号创建时间创建索引，一年建一个索引，搜索时默认增加时间限制
- 根据盘点单创建索引，也是一年一个索引